<!DOCTYPE html>
<html>
<head>
    <title>CORS Test</title>
</head>
<body>
    <h1>CORS Test for Backend</h1>
    <div style="margin: 20px 0;">
        <button onclick="quickServerCheck()" style="margin-right: 10px; padding: 10px 15px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">Quick Server Check</button>
        <button onclick="testCORS()" style="padding: 10px 15px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">Full CORS Test</button>
    </div>
    <div id="quick-status" style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px; display: none;"></div>
    <div id="results"></div>

    <script>
        async function quickServerCheck() {
            const statusDiv = document.getElementById('quick-status');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = 'üîÑ Checking server status...';
            
            const baseUrl = 'https://social-os-backend-6.onrender.com';
            
            try {
                const startTime = Date.now();
                const response = await fetch(baseUrl, { 
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache'
                });
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                
                if (response.ok) {
                    statusDiv.innerHTML = `‚úÖ <strong>Server is UP</strong> - Response time: ${responseTime}ms - Status: ${response.status}`;
                    statusDiv.style.background = '#d4edda';
                    statusDiv.style.color = '#155724';
                } else {
                    statusDiv.innerHTML = `‚ö†Ô∏è <strong>Server responded with error</strong> - Status: ${response.status} ${response.statusText}`;
                    statusDiv.style.background = '#fff3cd';
                    statusDiv.style.color = '#856404';
                }
            } catch (error) {
                statusDiv.innerHTML = `‚ùå <strong>Server is DOWN</strong> - Error: ${error.message}`;
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
            }
        }
        
        async function testCORS() {
            const results = document.getElementById('results');
            results.innerHTML = '<p>üîÑ Testing server connectivity...</p>';
            
            const baseUrl = 'https://social-os-backend-6.onrender.com';
            let testResults = [];
            
            // Test 1: Basic connectivity check
            try {
                console.log('üîç Testing basic connectivity...');
                const startTime = Date.now();
                const response = await fetch(baseUrl, { 
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache'
                });
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                
                testResults.push({
                    test: 'Basic Connectivity',
                    status: response.status,
                    success: response.ok,
                    time: responseTime,
                    details: `${response.status} ${response.statusText}`
                });
                
                console.log('‚úÖ Server is reachable:', response.status, response.statusText);
                
            } catch (error) {
                console.error('‚ùå Server connectivity failed:', error);
                testResults.push({
                    test: 'Basic Connectivity',
                    status: 'FAILED',
                    success: false,
                    time: 0,
                    details: error.message
                });
                
                // If basic connectivity fails, show results and exit
                results.innerHTML = `
                    <h3>‚ùå Server Connectivity Failed</h3>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p><strong>Possible causes:</strong></p>
                    <ul>
                        <li>Server is down or sleeping (Render free tier)</li>
                        <li>Network connectivity issues</li>
                        <li>DNS resolution problems</li>
                        <li>Server deployment failed</li>
                    </ul>
                    <p><strong>Solutions:</strong></p>
                    <ul>
                        <li>Check Render dashboard for deployment status</li>
                        <li>Wait a few minutes for server to wake up</li>
                        <li>Try accessing the URL directly in browser</li>
                        <li>Check server logs in Render dashboard</li>
                    </ul>
                `;
                return;
            }
            
            // Test 2: Health endpoint
            try {
                console.log('üè• Testing health endpoint...');
                const healthResponse = await fetch(`${baseUrl}/health`, {
                    method: 'GET',
                    mode: 'cors'
                });
                const healthData = await healthResponse.json();
                console.log('Health check result:', healthData);
                
                testResults.push({
                    test: 'Health Check',
                    status: healthResponse.status,
                    success: healthResponse.ok,
                    details: JSON.stringify(healthData, null, 2)
                });
                
            } catch (error) {
                console.error('‚ùå Health check failed:', error);
                testResults.push({
                    test: 'Health Check',
                    status: 'FAILED',
                    success: false,
                    details: error.message
                });
            }
            
            // Test 3: CORS test endpoint
            try {
                console.log('üåê Testing CORS endpoint...');
                const corsResponse = await fetch(`${baseUrl}/cors-test`, {
                    method: 'GET',
                    mode: 'cors'
                });
                const corsData = await corsResponse.json();
                console.log('CORS test result:', corsData);
                
                testResults.push({
                    test: 'CORS Test Endpoint',
                    status: corsResponse.status,
                    success: corsResponse.ok,
                    details: JSON.stringify(corsData, null, 2)
                });
                
            } catch (error) {
                console.error('‚ùå CORS test failed:', error);
                testResults.push({
                    test: 'CORS Test Endpoint',
                    status: 'FAILED',
                    success: false,
                    details: error.message
                });
            }
            
            // Test 4: OPTIONS preflight request
            try {
                console.log('üîß Testing OPTIONS preflight...');
                const optionsResponse = await fetch(`${baseUrl}/api/v1/auth/login`, {
                    method: 'OPTIONS',
                    mode: 'cors',
                    headers: {
                        'Origin': window.location.origin,
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type, Authorization'
                    }
                });
                
                const corsHeaders = {
                    'Access-Control-Allow-Origin': optionsResponse.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Methods': optionsResponse.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Headers': optionsResponse.headers.get('Access-Control-Allow-Headers'),
                    'Access-Control-Allow-Credentials': optionsResponse.headers.get('Access-Control-Allow-Credentials')
                };
                
                console.log('OPTIONS response headers:', corsHeaders);
                
                testResults.push({
                    test: 'OPTIONS Preflight',
                    status: optionsResponse.status,
                    success: optionsResponse.status === 200,
                    details: JSON.stringify(corsHeaders, null, 2)
                });
                
            } catch (error) {
                console.error('‚ùå OPTIONS preflight failed:', error);
                testResults.push({
                    test: 'OPTIONS Preflight',
                    status: 'FAILED',
                    success: false,
                    details: error.message
                });
            }
            
            // Display results
            let resultsHtml = '<h3>üß™ Test Results</h3>';
            testResults.forEach(result => {
                const icon = result.success ? '‚úÖ' : '‚ùå';
                const statusColor = result.success ? 'green' : 'red';
                resultsHtml += `
                    <div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                        <h4>${icon} ${result.test}</h4>
                        <p><strong>Status:</strong> <span style="color: ${statusColor}">${result.status}</span></p>
                        <details>
                            <summary>Details</summary>
                            <pre style="background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto;">${result.details}</pre>
                        </details>
                    </div>
                `;
            });
            
            results.innerHTML = resultsHtml;
        }
    </script>
</body>
</html>
